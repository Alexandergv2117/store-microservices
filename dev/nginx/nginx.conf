user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  # Auth service
  upstream auth {
    least_conn;
    server auth:5000;
  }

  # Product service
  upstream product {
    least_conn;
    server products:5300;
  }

  # User service
  upstream user {
    least_conn;
    server users:5200;
  }

  server {
    listen 80;
    server_name localhost;

    location / {
      root /usr/share/nginx/html;
      index index.html index.htm;
    }

    location = /protected {
      rewrite ^ /auth/validate break;
      proxy_set_header X-Original-URI $request_uri;
      proxy_pass http://auth;
    }

    location /product {
      auth_request /protected;
      proxy_pass http://product;
    }

    location /user {
      auth_request /protected;
      proxy_pass http://user;
    }
  }
}